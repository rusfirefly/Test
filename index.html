<!DOCTYPE html>
<html lang="en-us">
  <head>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>FarmsWorldGame</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <style>
      /* Минимальные стили для предотвращения скачков контента */
      body, html {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        overflow: hidden;
        background: #000;
      }
      #unity-container {
        position: absolute;
        width: 100%;
        height: 100%;
      }
      #unity-canvas {
        width: 100%;
        height: 100%;
        background: #000;
      }
    </style>
  </head>
  <body>
    <div id="unity-container">
      <canvas id="unity-canvas"></canvas>
      <div id="loading" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); color: white;">
        Loading...
      </div>
    </div>

    <script>
      // 1. Базовая инициализация
      function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.style = 'position: fixed; top: 0; left: 0; right: 0; background: red; color: white; padding: 10px;';
        errorDiv.textContent = message;
        document.body.appendChild(errorDiv);
        console.error(message);
      }

      // 2. Проверка поддержки WebAssembly
      if (!WebAssembly) {
        showError('Ваш браузер не поддерживает WebAssembly. Обновите браузер!');
        throw new Error('WebAssembly not supported');
      }

      // 3. Инициализация Telegram WebApp
      if (window.Telegram && Telegram.WebApp) {
        Telegram.WebApp.ready();
        Telegram.WebApp.expand();
      } else {
        console.warn('Telegram WebApp API не загружен');
      }

      // 4. Конфигурация Unity
      const buildPath = 'Build';
      const config = {
        dataUrl: `${buildPath}/Build.data`,
        frameworkUrl: `${buildPath}/Build.framework.js`,
        codeUrl: `${buildPath}/Build.wasm`,
        streamingAssetsUrl: 'StreamingAssets',
        companyName: 'DefaultCompany',
        productName: 'FarmsWorldGame',
        productVersion: '1.0',
        devicePixelRatio: 1 // Фиксированное значение для мобильных
      };

      // 5. Загрузка скрипта Unity
      const script = document.createElement('script');
      script.src = `${buildPath}/Build.loader.js`;
      script.onerror = () => showError('Ошибка загрузки скриптов игры!');
      
      script.onload = () => {
        if (!window.createUnityInstance) {
          showError('Unity Loader не загружен!');
          return;
        }

        // 6. Создание экземпляра Unity
        window.createUnityInstance(document.querySelector('#unity-canvas'), config, (progress) => {
          document.querySelector('#loading').textContent = `Loading ${Math.round(progress * 100)}%`;
        })
        .then((unityInstance) => {
          document.querySelector('#loading').remove();
          
          // 7. Адаптация под мобильные устройства
          const resizeHandler = () => {
            const canvas = document.querySelector('#unity-canvas');
            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';
          };
          
          window.addEventListener('resize', resizeHandler);
          resizeHandler();
        })
        .catch((error) => {
          showError(`Ошибка запуска: ${error.message}`);
        });
      };

      document.body.appendChild(script);
    </script>
  </body>
</html>